<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Viewer (WebRTC)</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #f0f2f5;
        margin: 0;
        padding: 40px 20px;
        text-align: center;
      }

      h2 {
        color: #333;
      }

      video {
        width: 80%;
        max-width: 960px;
        border: 2px solid #ccc;
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
      }
    </style>
  </head>
  <body>
    <h2>WebRTC Viewer</h2>
    <video id="remoteVideo" autoplay playsinline controls></video>

    <script>
      const video = document.getElementById("remoteVideo");

      let ws;
      let pc = null;
      let stream = null;

      function createPeerConnection() {
        const newPc = new RTCPeerConnection({
          iceServers: [{ urls: "stun:stun.l.google.com:19302" }],
        });

        newPc.onicecandidate = (e) => {
          if (e.candidate) {
            ws.send(
              JSON.stringify({ type: "candidate", candidate: e.candidate })
            );
          }
        };

        newPc.ontrack = (event) => {
          console.log("üé• New remote track received");
          if (stream) {
            // Remove previous stream tracks
            stream.getTracks().forEach((track) => track.stop());
          }

          stream = event.streams[0];
          video.srcObject = stream;
        };

        return newPc;
      }

      function setupWebSocket() {
        ws = new WebSocket(
          `${location.protocol === "https:" ? "wss" : "ws"}://${location.host}`
        );

        ws.onopen = () => {
          console.log("‚úÖ WebSocket connected to signaling server (Viewer)");
          ws.send(JSON.stringify({ type: "register", role: "viewer" }));
        };

        ws.onmessage = async ({ data }) => {
          try {
            const msg = JSON.parse(data);
            console.log("üì© Received signaling message:", msg);

            if (msg.type === "offer") {
              console.log("üîÅ New offer received ‚Äì resetting connection");

              if (pc) {
                pc.close();
                pc = null;
              }

              pc = createPeerConnection();

              await pc.setRemoteDescription(
                new RTCSessionDescription(msg.offer)
              );
              const answer = await pc.createAnswer();
              await pc.setLocalDescription(answer);

              ws.send(JSON.stringify({ type: "answer", answer }));
            }

            if (msg.type === "candidate" && msg.candidate && pc) {
              await pc.addIceCandidate(new RTCIceCandidate(msg.candidate));
            }
          } catch (err) {
            console.error("‚ùå Failed to process signaling message:", err);
          }
        };
      }

      setupWebSocket();
    </script>
  </body>
</html>
